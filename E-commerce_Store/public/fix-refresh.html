<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ”§ Fix ProblÃ¨me RafraÃ®chissement</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .alert {
            background: rgba(255, 107, 107, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ff4757;
        }
        .success {
            background: rgba(46, 204, 113, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2ecc71;
        }
        .btn {
            background: #3742fa;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(55, 66, 250, 0.3);
        }
        .btn:hover {
            background: #2f3542;
            transform: translateY(-2px);
        }
        .logs {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        h1 { text-align: center; margin-bottom: 30px; }
        h2 { border-bottom: 2px solid rgba(255, 255, 255, 0.3); padding-bottom: 10px; }
        .timestamp { opacity: 0.7; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Fix ProblÃ¨me de RafraÃ®chissement Infini</h1>
        
        <div class="alert">
            <strong>ğŸš¨ PROBLÃˆME IDENTIFIÃ‰ :</strong> RafraÃ®chissement automatique empÃªchant la connexion
        </div>
        
        <div id="solution-status" class="success">
            âœ… Solution anti-cache appliquÃ©e - Service Worker modifiÃ©
        </div>
        
        <div class="status-grid">
            <div class="status-card">
                <strong>ğŸŒ Connexion</strong><br>
                <span id="online-status">VÃ©rification...</span>
            </div>
            <div class="status-card">
                <strong>âš™ï¸ Service Worker</strong><br>
                <span id="sw-status">VÃ©rification...</span>
            </div>
            <div class="status-card">
                <strong>ğŸ—„ï¸ Cache</strong><br>
                <span id="cache-status">VÃ©rification...</span>
            </div>
            <div class="status-card">
                <strong>ğŸ” Authentification</strong><br>
                <span id="auth-status">Test en cours...</span>
            </div>
        </div>
        
        <h2>ğŸ§ª Actions de Test</h2>
        <button class="btn" onclick="clearAllCache()">ğŸ§¹ Vider Tout le Cache</button>
        <button class="btn" onclick="testAuth()">ğŸ” Test Connexion</button>
        <button class="btn" onclick="refreshPage()">ğŸ”„ Recharger Page</button>
        <button class="btn" onclick="goToMain()">ğŸ  Aller Ã  l'App</button>
        
        <h2>ğŸ“‹ Logs de Debug</h2>
        <div id="logs" class="logs">
            <div>ğŸš€ [<span class="timestamp"></span>] Page de rÃ©paration chargÃ©e</div>
        </div>
        
        <h2>ğŸ“ Instructions</h2>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 8px;">
            <ol>
                <li><strong>Videz le cache</strong> en cliquant sur "ğŸ§¹ Vider Tout le Cache"</li>
                <li><strong>Testez la connexion</strong> avec "ğŸ” Test Connexion"</li>
                <li><strong>Allez Ã  l'application</strong> avec "ğŸ  Aller Ã  l'App"</li>
                <li><strong>Si Ã§a ne marche pas :</strong> Fermez le navigateur, rouvrez et rÃ©essayez</li>
            </ol>
            
            <p><strong>ğŸ¯ RÃ©sultat attendu :</strong> Plus de rafraÃ®chissement automatique, connexion possible</p>
        </div>
    </div>
    
    <script>
        let logCount = 0;
        
        function updateTimestamp() {
            const timestamps = document.querySelectorAll('.timestamp');
            timestamps.forEach(ts => {
                ts.textContent = new Date().toLocaleTimeString();
            });
        }
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff4757' : type === 'success' ? '#2ecc71' : '#00ff00';
            
            logs.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
            logCount++;
            
            // Limiter le nombre de logs
            if (logCount > 50) {
                const lines = logs.innerHTML.split('<div').slice(-40);
                logs.innerHTML = lines.join('<div');
                logCount = 40;
            }
        }
        
        function updateStatus(elementId, text, success = true) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.style.color = success ? '#2ecc71' : '#ff4757';
        }
        
        function clearAllCache() {
            log('ğŸ§¹ Nettoyage complet du cache...');
            
            // DÃ©sinscrire tous les service workers
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(reg => {
                        reg.unregister();
                        log('âŒ Service Worker dÃ©sinscrit: ' + reg.scope);
                    });
                });
            }
            
            // Vider tous les caches
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                        log('ğŸ—‘ï¸ Cache supprimÃ©: ' + name);
                    });
                    updateStatus('cache-status', 'VidÃ©', true);
                });
            }
            
            // Clear localStorage et sessionStorage
            try {
                localStorage.clear();
                sessionStorage.clear();
                log('âœ… Storage local vidÃ©');
            } catch(e) {
                log('âš ï¸ Erreur vidage storage: ' + e.message, 'error');
            }
            
            log('âœ… Nettoyage complet terminÃ©');
            
            // Recharger la page aprÃ¨s un dÃ©lai
            setTimeout(() => {
                log('ğŸ”„ Rechargement de la page...');
                window.location.reload(true);
            }, 2000);
        }
        
        function testAuth() {
            log('ğŸ” Test de l\'authentification...');
            updateStatus('auth-status', 'Test en cours...', true);
            
            // Test de l'API backend
            fetch('/api/auth/me', {
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Status: ' + response.status);
                }
            })
            .then(data => {
                log('âœ… API accessible: ' + JSON.stringify(data), 'success');
                updateStatus('auth-status', 'API OK', true);
            })
            .catch(error => {
                log('âŒ Erreur API: ' + error.message, 'error');
                updateStatus('auth-status', 'Erreur: ' + error.message, false);
                
                // Test de connectivitÃ© basique
                fetch('/', { method: 'HEAD', cache: 'no-store' })
                    .then(() => {
                        log('âœ… Serveur accessible, problÃ¨me API seulement', 'success');
                    })
                    .catch(() => {
                        log('âŒ Serveur inaccessible', 'error');
                    });
            });
        }
        
        function refreshPage() {
            log('ğŸ”„ Rechargement forcÃ© de la page...');
            window.location.reload(true);
        }
        
        function goToMain() {
            log('ğŸ  Redirection vers l\'application principale...');
            window.location.href = '/';
        }
        
        function checkConnectivity() {
            if (navigator.onLine) {
                updateStatus('online-status', 'En ligne', true);
                log('ğŸŒ Connexion internet active');
            } else {
                updateStatus('online-status', 'Hors ligne', false);
                log('ğŸ“¡ Mode hors ligne dÃ©tectÃ©');
            }
        }
        
        function checkServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    if (registrations.length > 0) {
                        updateStatus('sw-status', `${registrations.length} actif(s)`, true);
                        log(`âš™ï¸ Service Worker(s) trouvÃ©(s): ${registrations.length}`);
                        
                        registrations.forEach((reg, i) => {
                            log(`SW ${i+1}: ${reg.scope} - Ã‰tat: ${reg.active ? 'Actif' : 'Inactif'}`);
                        });
                    } else {
                        updateStatus('sw-status', 'Aucun', true);
                        log('âš™ï¸ Aucun Service Worker actif');
                    }
                });
            } else {
                updateStatus('sw-status', 'Non supportÃ©', false);
                log('âŒ Service Worker non supportÃ©');
            }
        }
        
        function checkCache() {
            if ('caches' in window) {
                caches.keys().then(names => {
                    updateStatus('cache-status', `${names.length} cache(s)`, names.length === 0);
                    if (names.length > 0) {
                        log(`ğŸ—„ï¸ Caches trouvÃ©s: ${names.join(', ')}`);
                    } else {
                        log('âœ… Aucun cache prÃ©sent');
                    }
                });
            } else {
                updateStatus('cache-status', 'Non supportÃ©', false);
            }
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            updateTimestamp();
            log('ğŸš€ Page de rÃ©paration initialisÃ©e');
            
            // VÃ©rifications automatiques
            checkConnectivity();
            checkServiceWorker();
            checkCache();
            
            // Test automatique de l'auth aprÃ¨s 1 seconde
            setTimeout(testAuth, 1000);
            
            // Mise Ã  jour pÃ©riodique
            setInterval(() => {
                checkConnectivity();
                checkServiceWorker();
                checkCache();
            }, 5000);
        });
        
        // Ã‰couter les Ã©vÃ©nements de connectivitÃ©
        window.addEventListener('online', () => {
            log('ğŸŒ Connexion rÃ©tablie', 'success');
            checkConnectivity();
        });
        
        window.addEventListener('offline', () => {
            log('ğŸ“¡ Connexion perdue', 'error');
            checkConnectivity();
        });
        
        log('âœ… Script de rÃ©paration chargÃ© et prÃªt');
    </script>
</body>
</html>