<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Mode Offline - E-Commerce</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        .test-button.danger {
            background: #dc3545;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.warning {
            background: #ffc107;
            color: #333;
        }
        .result {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #007bff;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            margin: 5px;
        }
        .online {
            background: #d4edda;
            color: #155724;
        }
        .offline {
            background: #f8d7da;
            color: #721c24;
        }
        .cache-info {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .feature-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        .feature-card.active {
            border-color: #28a745;
            background: #d4edda;
        }
        .logs {
            background: #343a40;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸŒ Test Mode Offline - E-Commerce Store</h1>
        <p>Testeur des fonctionnalitÃ©s PWA et Service Worker</p>
        <div>
            <span id="connection-status" class="status">ğŸ”„ VÃ©rification...</span>
            <span id="sw-status" class="status">ğŸ”„ Chargement SW...</span>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ Tests de ConnectivitÃ©</h2>
        <button class="test-button" onclick="testConnection()">ğŸŒ Tester la connexion</button>
        <button class="test-button warning" onclick="simulateOffline()">ğŸ“¡ Simuler mode offline</button>
        <button class="test-button success" onclick="simulateOnline()">ğŸ”„ Simuler reconnexion</button>
        <div id="connection-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>âš™ï¸ Tests Service Worker</h2>
        <button class="test-button" onclick="checkServiceWorker()">ğŸ” VÃ©rifier SW</button>
        <button class="test-button" onclick="updateServiceWorker()">ğŸ”„ Mettre Ã  jour SW</button>
        <button class="test-button danger" onclick="unregisterServiceWorker()">âŒ DÃ©sactiver SW</button>
        <button class="test-button success" onclick="registerServiceWorker()">âœ… RÃ©activer SW</button>
        <div id="sw-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ’¾ Tests Cache</h2>
        <button class="test-button" onclick="checkCache()">ğŸ“¦ VÃ©rifier cache</button>
        <button class="test-button" onclick="clearCache()">ğŸ—‘ï¸ Vider cache</button>
        <button class="test-button" onclick="cacheCurrentPage()">ğŸ’¾ Mettre en cache</button>
        <div id="cache-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª Tests API Offline</h2>
        <button class="test-button" onclick="testApiCall()">ğŸŒ Test API normale</button>
        <button class="test-button" onclick="testApiOffline()">ğŸ“¡ Test API offline</button>
        <button class="test-button" onclick="testAuthOffline()">ğŸ” Test auth offline</button>
        <div id="api-result" class="result" style="display: none;"></div>
    </div>

    <div class="cache-info">
        <h3>ğŸ“Š Ã‰tat du Cache</h3>
        <div class="feature-grid">
            <div class="feature-card" id="cache-pages">
                <strong>Pages en Cache</strong><br>
                <span id="cached-pages-count">0</span> pages
            </div>
            <div class="feature-card" id="cache-assets">
                <strong>Ressources</strong><br>
                <span id="cached-assets-count">0</span> fichiers
            </div>
            <div class="feature-card" id="cache-size">
                <strong>Taille Cache</strong><br>
                <span id="cache-size-value">0 KB</span>
            </div>
            <div class="feature-card" id="sw-version">
                <strong>Version SW</strong><br>
                <span id="sw-version-value">-</span>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ Logs en Temps RÃ©el</h2>
        <button class="test-button" onclick="clearLogs()">ğŸ—‘ï¸ Vider logs</button>
        <div id="logs" class="logs">
            <div>ğŸ”§ Initialisation des tests...</div>
        </div>
    </div>

    <script>
        let isOfflineSimulated = false;
        
        // Fonction de log
        function log(message) {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `<div>[${time}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        // Mise Ã  jour des statuts
        function updateStatuses() {
            const connectionStatus = document.getElementById('connection-status');
            const swStatus = document.getElementById('sw-status');
            
            if (navigator.onLine) {
                connectionStatus.textContent = 'ğŸŒ En ligne';
                connectionStatus.className = 'status online';
            } else {
                connectionStatus.textContent = 'ğŸ“¡ Hors ligne';
                connectionStatus.className = 'status offline';
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    if (registration) {
                        swStatus.textContent = 'âœ… SW Actif';
                        swStatus.className = 'status online';
                    } else {
                        swStatus.textContent = 'âŒ SW Inactif';
                        swStatus.className = 'status offline';
                    }
                }).catch(() => {
                    swStatus.textContent = 'âŒ SW Erreur';
                    swStatus.className = 'status offline';
                });
            } else {
                swStatus.textContent = 'âŒ SW Non supportÃ©';
                swStatus.className = 'status offline';
            }
        }

        // Test de connexion
        function testConnection() {
            const result = document.getElementById('connection-result');
            result.style.display = 'block';
            result.innerHTML = 'ğŸ”„ Test de connexion en cours...';
            
            log('ğŸŒ Test de connexion dÃ©marrÃ©');
            
            fetch('/', { 
                method: 'HEAD',
                cache: 'no-store'
            })
            .then(response => {
                if (response.ok) {
                    result.innerHTML = 'âœ… Connexion OK - Serveur accessible';
                    log('âœ… Connexion rÃ©ussie');
                } else {
                    result.innerHTML = `âš ï¸ Connexion partielle - Status: ${response.status}`;
                    log(`âš ï¸ RÃ©ponse serveur: ${response.status}`);
                }
            })
            .catch(error => {
                result.innerHTML = 'âŒ Pas de connexion - Mode offline dÃ©tectÃ©';
                log(`âŒ Erreur connexion: ${error.message}`);
            });
        }

        // Simulation offline
        function simulateOffline() {
            log('ğŸ“¡ Simulation mode offline');
            // DÃ©clencher l'Ã©vÃ©nement offline
            window.dispatchEvent(new Event('offline'));
            isOfflineSimulated = true;
            updateStatuses();
        }

        function simulateOnline() {
            log('ğŸŒ Simulation retour online');
            // DÃ©clencher l'Ã©vÃ©nement online
            window.dispatchEvent(new Event('online'));
            isOfflineSimulated = false;
            updateStatuses();
        }

        // Tests Service Worker
        function checkServiceWorker() {
            const result = document.getElementById('sw-result');
            result.style.display = 'block';
            
            if (!('serviceWorker' in navigator)) {
                result.innerHTML = 'âŒ Service Worker non supportÃ© dans ce navigateur';
                log('âŒ SW non supportÃ©');
                return;
            }

            navigator.serviceWorker.getRegistrations().then(registrations => {
                let info = `ğŸ“Š Service Workers trouvÃ©s: ${registrations.length}<br>`;
                
                registrations.forEach((registration, index) => {
                    info += `SW ${index + 1}: ${registration.scope}<br>`;
                    info += `Ã‰tat: ${registration.active ? 'Actif' : 'Inactif'}<br>`;
                });
                
                result.innerHTML = info;
                log(`ğŸ” SW check: ${registrations.length} trouvÃ©(s)`);
            });
        }

        function registerServiceWorker() {
            log('ğŸ”„ Enregistrement du Service Worker...');
            
            if (!('serviceWorker' in navigator)) {
                log('âŒ Service Worker non supportÃ©');
                return;
            }

            navigator.serviceWorker.register('/sw.js', { scope: '/' })
                .then(registration => {
                    log('âœ… Service Worker enregistrÃ© avec succÃ¨s');
                    updateStatuses();
                })
                .catch(error => {
                    log(`âŒ Erreur enregistrement SW: ${error.message}`);
                });
        }

        function unregisterServiceWorker() {
            log('âŒ DÃ©sactivation du Service Worker...');
            
            navigator.serviceWorker.getRegistrations().then(registrations => {
                Promise.all(
                    registrations.map(registration => registration.unregister())
                ).then(() => {
                    log('âœ… Tous les Service Workers dÃ©sactivÃ©s');
                    updateStatuses();
                });
            });
        }

        // Tests Cache
        function checkCache() {
            const result = document.getElementById('cache-result');
            result.style.display = 'block';
            
            log('ğŸ” VÃ©rification du cache...');
            
            caches.keys().then(cacheNames => {
                let info = `ğŸ“¦ Caches trouvÃ©s: ${cacheNames.length}<br>`;
                
                Promise.all(
                    cacheNames.map(async cacheName => {
                        const cache = await caches.open(cacheName);
                        const keys = await cache.keys();
                        return `${cacheName}: ${keys.length} Ã©lÃ©ments`;
                    })
                ).then(details => {
                    info += details.join('<br>');
                    result.innerHTML = info;
                    log(`ğŸ“¦ Cache check: ${cacheNames.length} cache(s)`);
                });
            });
        }

        function clearCache() {
            log('ğŸ—‘ï¸ Nettoyage du cache...');
            
            caches.keys().then(cacheNames => {
                Promise.all(
                    cacheNames.map(cacheName => caches.delete(cacheName))
                ).then(() => {
                    log('âœ… Cache vidÃ© complÃ¨tement');
                    checkCache();
                });
            });
        }

        // Tests API
        function testApiCall() {
            const result = document.getElementById('api-result');
            result.style.display = 'block';
            result.innerHTML = 'ğŸ”„ Test API en cours...';
            
            log('ğŸŒ Test appel API normal');
            
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    result.innerHTML = `âœ… API OK: ${JSON.stringify(data)}`;
                    log('âœ… API rÃ©pond normalement');
                })
                .catch(error => {
                    result.innerHTML = `âŒ API Error: ${error.message}`;
                    log(`âŒ Erreur API: ${error.message}`);
                });
        }

        function testApiOffline() {
            const result = document.getElementById('api-result');
            result.style.display = 'block';
            
            log('ğŸ“¡ Test API en mode offline');
            
            // Simuler une requÃªte API qui devrait Ã©chouer en offline
            fetch('/api/products', { cache: 'no-store' })
                .then(response => {
                    if (response.status === 503) {
                        return response.json().then(data => {
                            result.innerHTML = `ğŸ“¡ Mode Offline dÃ©tectÃ©: ${data.message}`;
                            log('ğŸ“¡ Service Worker rÃ©pond correctement en offline');
                        });
                    } else {
                        result.innerHTML = 'ğŸŒ API accessible (pas en mode offline)';
                        log('ğŸŒ API toujours accessible');
                    }
                })
                .catch(error => {
                    result.innerHTML = `ğŸ“¡ Offline confirmÃ©: ${error.message}`;
                    log(`ğŸ“¡ Mode offline confirmÃ©: ${error.message}`);
                });
        }

        // Ã‰couteurs d'Ã©vÃ©nements
        window.addEventListener('online', () => {
            log('ğŸŒ Ã‰vÃ©nement ONLINE dÃ©tectÃ©');
            updateStatuses();
        });

        window.addEventListener('offline', () => {
            log('ğŸ“¡ Ã‰vÃ©nement OFFLINE dÃ©tectÃ©');
            updateStatuses();
        });

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div>ğŸ—‘ï¸ Logs vidÃ©s</div>';
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ Page de test chargÃ©e');
            updateStatuses();
            
            // VÃ©rification pÃ©riodique
            setInterval(updateStatuses, 5000);
            
            // Tests automatiques au chargement
            setTimeout(() => {
                checkServiceWorker();
                checkCache();
            }, 1000);
        });
    </script>
</body>
</html>