<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Admin Session</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { border-color: #28a745; background-color: #d4edda; }
        .error { border-color: #dc3545; background-color: #f8d7da; }
        .warning { border-color: #ffc107; background-color: #fff3cd; }
        pre {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic Admin Session</h1>
        <p>Cet outil va diagnostiquer pourquoi la session admin ne s'ouvre pas apr√®s la connexion.</p>
        
        <button onclick="checkBackend()">1. ‚úÖ V√©rifier Backend</button>
        <button onclick="testLogin()">2. üîê Tester Login</button>
        <button onclick="checkLocalStorage()">3. üíæ V√©rifier localStorage</button>
        <button onclick="testAdminRoute()">4. üõ°Ô∏è Tester AdminRoute Logic</button>
        <button onclick="clearSession()">5. üóëÔ∏è Vider Session</button>
        
        <div id="results"></div>
    </div>

    <script>
        const results = document.getElementById('results');
        
        function addResult(title, content, type = 'result') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<h3>${title}</h3><div>${content}</div>`;
            results.appendChild(div);
        }
        
        async function checkBackend() {
            try {
                const response = await fetch('http://localhost:5000/api/health');
                if (response.ok) {
                    addResult('‚úÖ Backend Status', 'Backend accessible sur http://localhost:5000', 'success');
                } else {
                    addResult('‚ùå Backend Status', `Erreur HTTP: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult('‚ùå Backend Status', `Backend inaccessible: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            try {
                const response = await fetch('http://localhost:5000/api/admin/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'ayarirayen539@gmail.com',
                        password: 'admin123'
                    }),
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Stocker dans localStorage comme le fait AdminLogin
                    localStorage.setItem('adminToken', data.token);
                    localStorage.setItem('adminUser', JSON.stringify(data.admin));
                    
                    addResult('‚úÖ Login Test', 
                        `<strong>Connexion r√©ussie!</strong><br/>
                        Token: ${data.token.substring(0, 50)}...<br/>
                        Admin: ${JSON.stringify(data.admin, null, 2)}<br/>
                        <em>Donn√©es stock√©es dans localStorage</em>`, 'success');
                } else {
                    addResult('‚ùå Login Test', `√âchec: ${data.message}`, 'error');
                }
            } catch (error) {
                addResult('‚ùå Login Test', `Erreur: ${error.message}`, 'error');
            }
        }
        
        function checkLocalStorage() {
            const token = localStorage.getItem('adminToken');
            const userStr = localStorage.getItem('adminUser');
            
            let content = '<strong>√âtat localStorage:</strong><br/>';
            
            if (!token) {
                content += '‚ùå adminToken: Non trouv√©<br/>';
            } else {
                content += `‚úÖ adminToken: ${token.substring(0, 50)}...<br/>`;
            }
            
            if (!userStr) {
                content += '‚ùå adminUser: Non trouv√©<br/>';
            } else {
                try {
                    const user = JSON.parse(userStr);
                    content += `‚úÖ adminUser: <pre>${JSON.stringify(user, null, 2)}</pre>`;
                    
                    // V√©rifier les champs requis
                    if (user.role === 'admin') {
                        content += '‚úÖ Role: Correct ("admin")<br/>';
                    } else {
                        content += `‚ùå Role: Incorrect ("${user.role}" au lieu de "admin")<br/>`;
                    }
                } catch (e) {
                    content += `‚ùå adminUser: JSON invalide - ${e.message}<br/>`;
                }
            }
            
            addResult('üíæ localStorage Check', content, token && userStr ? 'success' : 'error');
        }
        
        function testAdminRoute() {
            const token = localStorage.getItem('adminToken');
            const userStr = localStorage.getItem('adminUser');
            
            let content = '<strong>Test logique AdminRoute:</strong><br/>';
            
            if (!token || !userStr) {
                content += '‚ùå Test 1: Pas de token ou user ‚Üí Redirection vers /admin/login<br/>';
                addResult('üõ°Ô∏è AdminRoute Test', content, 'error');
                return;
            }
            
            content += '‚úÖ Test 1: Token et user pr√©sents<br/>';
            
            try {
                const admin = JSON.parse(userStr);
                content += '‚úÖ Test 2: JSON parsing r√©ussi<br/>';
                
                // Reproduire la logique d'AdminRoute
                if (admin.role && admin.role !== 'admin') {
                    content += `‚ùå Test 3: R√¥le incorrect ("${admin.role}" != "admin") ‚Üí Redirection<br/>`;
                    content += '<strong>üîç PROBL√àME IDENTIFI√â: Le r√¥le n\'est pas "admin"</strong>';
                    addResult('üõ°Ô∏è AdminRoute Test', content, 'error');
                    return;
                }
                
                content += '‚úÖ Test 3: R√¥le correct ou absent<br/>';
                content += '‚úÖ <strong>AdminRoute devrait autoriser l\'acc√®s!</strong><br/>';
                content += '<em>Si vous voyez encore "404", le probl√®me est ailleurs (routing React)</em>';
                
                addResult('üõ°Ô∏è AdminRoute Test', content, 'success');
                
            } catch (error) {
                content += `‚ùå Test 2: Erreur parsing JSON: ${error.message} ‚Üí Redirection<br/>`;
                addResult('üõ°Ô∏è AdminRoute Test', content, 'error');
            }
        }
        
        function clearSession() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            addResult('üóëÔ∏è Session Cleared', 'localStorage vid√©. Vous pouvez retester la connexion.', 'warning');
        }
        
        // Diagnostic automatique au chargement
        window.onload = function() {
            addResult('üöÄ Diagnostic D√©marr√©', 'Cliquez sur les boutons ci-dessus pour diagnostiquer le probl√®me.', 'warning');
        };
    </script>
</body>
</html>