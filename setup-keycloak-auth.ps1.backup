# Script de configuration automatique Keycloak pour E-commerce Store
# Authentification Admin et User

Write-Host "üöÄ Configuration Keycloak pour E-commerce Store" -ForegroundColor Cyan
Write-Host "================================================" -ForegroundColor Cyan
Write-Host ""

# Variables de configuration
$KEYCLOAK_URL = "http://localhost:9090"
$ADMIN_USER = "admin"
$ADMIN_PASSWORD = "admin123"
$REALM_NAME = "ecommerce"

# Fonction pour obtenir le token admin
function Get-AdminToken {
    Write-Host "üîë Obtention du token admin..." -ForegroundColor Yellow
    
    $body = @{
        username = $ADMIN_USER
        password = $ADMIN_PASSWORD
        grant_type = "password"
        client_id = "admin-cli"
    }
    
    try {
        $response = Invoke-RestMethod -Uri "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" `
            -Method Post -Body $body -ContentType "application/x-www-form-urlencoded"
        Write-Host "‚úÖ Token obtenu avec succ√®s" -ForegroundColor Green
        return $response.access_token
    } catch {
        Write-Host "‚ùå Erreur lors de l'obtention du token: $_" -ForegroundColor Red
        exit 1
    }
}

# Fonction pour cr√©er le realm
function New-Realm {
    param($token)
    
    Write-Host "üåç Cr√©ation du realm '$REALM_NAME'..." -ForegroundColor Yellow
    
    $realmConfig = @{
        realm = $REALM_NAME
        enabled = $true
        displayName = "E-commerce Store"
        displayNameHtml = "<b>E-commerce</b> Store"
        registrationAllowed = $true
        registrationEmailAsUsername = $false
        editUsernameAllowed = $false
        resetPasswordAllowed = $true
        rememberMe = $true
        verifyEmail = $false
        loginWithEmailAllowed = $true
        duplicateEmailsAllowed = $false
        sslRequired = "none"
        accessTokenLifespan = 3600
        accessTokenLifespanForImplicitFlow = 900
        ssoSessionIdleTimeout = 1800
        ssoSessionMaxLifespan = 36000
    } | ConvertTo-Json -Depth 10
    
    try {
        $headers = @{
            "Authorization" = "Bearer $token"
            "Content-Type" = "application/json"
        }
        
        Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms" `
            -Method Post -Headers $headers -Body $realmConfig
        Write-Host "‚úÖ Realm cr√©√© avec succ√®s" -ForegroundColor Green
    } catch {
        if ($_.Exception.Response.StatusCode -eq 409) {
            Write-Host "‚ö†Ô∏è  Realm existe d√©j√†, utilisation du realm existant" -ForegroundColor Yellow
        } else {
            Write-Host "‚ùå Erreur lors de la cr√©ation du realm: $_" -ForegroundColor Red
        }
    }
}

# Fonction pour cr√©er les r√¥les
function New-Roles {
    param($token)
    
    Write-Host "üë• Cr√©ation des r√¥les..." -ForegroundColor Yellow
    
    $roles = @(
        @{ name = "super-admin"; description = "Super administrateur avec tous les droits" },
        @{ name = "admin"; description = "Administrateur avec droits de gestion" },
        @{ name = "manager"; description = "Manager avec droits limit√©s" },
        @{ name = "client"; description = "Client standard" },
        @{ name = "user"; description = "Utilisateur standard" }
    )
    
    $headers = @{
        "Authorization" = "Bearer $token"
        "Content-Type" = "application/json"
    }
    
    foreach ($role in $roles) {
        try {
            $roleBody = $role | ConvertTo-Json
            Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/roles" `
                -Method Post -Headers $headers -Body $roleBody
            Write-Host "  ‚úÖ R√¥le '$($role.name)' cr√©√©" -ForegroundColor Green
        } catch {
            if ($_.Exception.Response.StatusCode -eq 409) {
                Write-Host "  ‚ö†Ô∏è  R√¥le '$($role.name)' existe d√©j√†" -ForegroundColor Yellow
            } else {
                Write-Host "  ‚ùå Erreur pour le r√¥le '$($role.name)': $_" -ForegroundColor Red
            }
        }
    }
}

# Fonction pour cr√©er le client Admin
function New-AdminClient {
    param($token)
    
    Write-Host "üîê Cr√©ation du client Admin..." -ForegroundColor Yellow
    
    $adminClient = @{
        clientId = "ecommerce-admin"
        name = "E-commerce Admin Console"
        description = "Client pour l'interface d'administration"
        enabled = $true
        publicClient = $true
        directAccessGrantsEnabled = $true
        standardFlowEnabled = $true
        implicitFlowEnabled = $false
        serviceAccountsEnabled = $false
        protocol = "openid-connect"
        rootUrl = "http://localhost:5173"
        baseUrl = "/admin"
        redirectUris = @(
            "http://localhost:5173/*",
            "http://localhost:5173/admin/*"
        )
        webOrigins = @(
            "http://localhost:5173"
        )
        attributes = @{
            "pkce.code.challenge.method" = "S256"
        }
        defaultRoles = @("admin")
    } | ConvertTo-Json -Depth 10
    
    try {
        $headers = @{
            "Authorization" = "Bearer $token"
            "Content-Type" = "application/json"
        }
        
        Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/clients" `
            -Method Post -Headers $headers -Body $adminClient
        Write-Host "‚úÖ Client Admin cr√©√© avec succ√®s" -ForegroundColor Green
    } catch {
        if ($_.Exception.Response.StatusCode -eq 409) {
            Write-Host "‚ö†Ô∏è  Client Admin existe d√©j√†" -ForegroundColor Yellow
        } else {
            Write-Host "‚ùå Erreur lors de la cr√©ation du client Admin: $_" -ForegroundColor Red
        }
    }
}

# Fonction pour cr√©er le client Frontend (Users)
function New-FrontendClient {
    param($token)
    
    Write-Host "üåê Cr√©ation du client Frontend (Users)..." -ForegroundColor Yellow
    
    $frontendClient = @{
        clientId = "ecommerce-frontend"
        name = "E-commerce Frontend"
        description = "Client pour les utilisateurs finaux"
        enabled = $true
        publicClient = $true
        directAccessGrantsEnabled = $true
        standardFlowEnabled = $true
        implicitFlowEnabled = $false
        serviceAccountsEnabled = $false
        protocol = "openid-connect"
        rootUrl = "http://localhost:5173"
        baseUrl = "/"
        redirectUris = @(
            "http://localhost:5173/*"
        )
        webOrigins = @(
            "http://localhost:5173"
        )
        attributes = @{
            "pkce.code.challenge.method" = "S256"
        }
        defaultRoles = @("client")
    } | ConvertTo-Json -Depth 10
    
    try {
        $headers = @{
            "Authorization" = "Bearer $token"
            "Content-Type" = "application/json"
        }
        
        Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/clients" `
            -Method Post -Headers $headers -Body $frontendClient
        Write-Host "‚úÖ Client Frontend cr√©√© avec succ√®s" -ForegroundColor Green
    } catch {
        if ($_.Exception.Response.StatusCode -eq 409) {
            Write-Host "‚ö†Ô∏è  Client Frontend existe d√©j√†" -ForegroundColor Yellow
        } else {
            Write-Host "‚ùå Erreur lors de la cr√©ation du client Frontend: $_" -ForegroundColor Red
        }
    }
}

# Fonction pour cr√©er le client Backend
function New-BackendClient {
    param($token)
    
    Write-Host "‚öôÔ∏è  Cr√©ation du client Backend..." -ForegroundColor Yellow
    
    $backendClient = @{
        clientId = "ecommerce-backend"
        name = "E-commerce Backend API"
        description = "Client pour l'API backend"
        enabled = $true
        publicClient = $false
        bearerOnly = $true
        standardFlowEnabled = $false
        directAccessGrantsEnabled = $false
        serviceAccountsEnabled = $false
        protocol = "openid-connect"
    } | ConvertTo-Json -Depth 10
    
    try {
        $headers = @{
            "Authorization" = "Bearer $token"
            "Content-Type" = "application/json"
        }
        
        Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/clients" `
            -Method Post -Headers $headers -Body $backendClient
        Write-Host "‚úÖ Client Backend cr√©√© avec succ√®s" -ForegroundColor Green
    } catch {
        if ($_.Exception.Response.StatusCode -eq 409) {
            Write-Host "‚ö†Ô∏è  Client Backend existe d√©j√†" -ForegroundColor Yellow
        } else {
            Write-Host "‚ùå Erreur lors de la cr√©ation du client Backend: $_" -ForegroundColor Red
        }
    }
}

# Fonction pour cr√©er un utilisateur admin de test
function New-TestAdmin {
    param($token)
    
    Write-Host "üë§ Cr√©ation d'un utilisateur admin de test..." -ForegroundColor Yellow
    
    $testAdmin = @{
        username = "testadmin"
        email = "admin@ecommerce.com"
        firstName = "Test"
        lastName = "Admin"
        enabled = $true
        emailVerified = $true
        credentials = @(
            @{
                type = "password"
                value = "Admin123!"
                temporary = $false
            }
        )
    } | ConvertTo-Json -Depth 10
    
    try {
        $headers = @{
            "Authorization" = "Bearer $token"
            "Content-Type" = "application/json"
        }
        
        $null = Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/users" `
            -Method Post -Headers $headers -Body $testAdmin
        Write-Host "‚úÖ Utilisateur admin de test cr√©√© (testadmin / Admin123!)" -ForegroundColor Green
        
        # Attribuer le r√¥le super-admin
        Start-Sleep -Seconds 1
        
        # Obtenir l'ID de l'utilisateur
        $users = Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/users?username=testadmin" `
            -Method Get -Headers $headers
        $userId = $users[0].id
        
        # Obtenir l'ID du r√¥le super-admin
        $role = Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/roles/super-admin" `
            -Method Get -Headers $headers
        
        # Assigner le r√¥le
        $roleMapping = @(@{
            id = $role.id
            name = $role.name
        }) | ConvertTo-Json -Depth 10 -AsArray
        
        Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/users/$userId/role-mappings/realm" `
            -Method Post -Headers $headers -Body $roleMapping
        Write-Host "‚úÖ R√¥le super-admin assign√©" -ForegroundColor Green
        
    } catch {
        if ($_.Exception.Response.StatusCode -eq 409) {
            Write-Host "‚ö†Ô∏è  Utilisateur admin de test existe d√©j√†" -ForegroundColor Yellow
        } else {
            Write-Host "‚ùå Erreur lors de la cr√©ation de l'utilisateur: $_" -ForegroundColor Red
        }
    }
}

# Fonction pour cr√©er un utilisateur client de test
function New-TestUser {
    param($token)
    
    Write-Host "üë§ Cr√©ation d'un utilisateur client de test..." -ForegroundColor Yellow
    
    $testUser = @{
        username = "testuser"
        email = "user@ecommerce.com"
        firstName = "Test"
        lastName = "User"
        enabled = $true
        emailVerified = $true
        credentials = @(
            @{
                type = "password"
                value = "User123!"
                temporary = $false
            }
        )
    } | ConvertTo-Json -Depth 10
    
    try {
        $headers = @{
            "Authorization" = "Bearer $token"
            "Content-Type" = "application/json"
        }
        
        Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/users" `
            -Method Post -Headers $headers -Body $testUser
        Write-Host "‚úÖ Utilisateur client de test cr√©√© (testuser / User123!)" -ForegroundColor Green
        
        # Attribuer le r√¥le client
        Start-Sleep -Seconds 1
        
        $users = Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/users?username=testuser" `
            -Method Get -Headers $headers
        $userId = $users[0].id
        
        $role = Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/roles/client" `
            -Method Get -Headers $headers
        
        $roleMapping = @(@{
            id = $role.id
            name = $role.name
        }) | ConvertTo-Json -Depth 10 -AsArray
        
        Invoke-RestMethod -Uri "$KEYCLOAK_URL/admin/realms/$REALM_NAME/users/$userId/role-mappings/realm" `
            -Method Post -Headers $headers -Body $roleMapping
        Write-Host "‚úÖ R√¥le client assign√©" -ForegroundColor Green
        
    } catch {
        if ($_.Exception.Response.StatusCode -eq 409) {
            Write-Host "‚ö†Ô∏è  Utilisateur client de test existe d√©j√†" -ForegroundColor Yellow
        } else {
            Write-Host "‚ùå Erreur lors de la cr√©ation de l'utilisateur: $_" -ForegroundColor Red
        }
    }
}

# Ex√©cution principale
Write-Host "‚è≥ V√©rification de la disponibilit√© de Keycloak..." -ForegroundColor Yellow
try {
    $null = Invoke-RestMethod -Uri "$KEYCLOAK_URL/health/ready" -TimeoutSec 5
    Write-Host "‚úÖ Keycloak est pr√™t!" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Keycloak n'est pas accessible sur $KEYCLOAK_URL" -ForegroundColor Red
    Write-Host "   Assurez-vous que Keycloak est d√©marr√© avec: docker-compose up -d" -ForegroundColor Yellow
    exit 1
}

Write-Host ""

# Obtenir le token
$token = Get-AdminToken

# Cr√©er la configuration
New-Realm -token $token
Start-Sleep -Seconds 2

New-Roles -token $token
Start-Sleep -Seconds 2

New-AdminClient -token $token
Start-Sleep -Seconds 1

New-FrontendClient -token $token
Start-Sleep -Seconds 1

New-BackendClient -token $token
Start-Sleep -Seconds 2

New-TestAdmin -token $token
Start-Sleep -Seconds 2

New-TestUser -token $token

Write-Host ""
Write-Host "================================================" -ForegroundColor Cyan
Write-Host "‚ú® Configuration Keycloak termin√©e!" -ForegroundColor Green
Write-Host "================================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "üìã Informations de connexion:" -ForegroundColor Yellow
Write-Host ""
Write-Host "üåê Console Keycloak: http://localhost:8180" -ForegroundColor Cyan
Write-Host "   Admin: $ADMIN_USER / $ADMIN_PASSWORD" -ForegroundColor White
Write-Host ""
Write-Host "üîê Realm: $REALM_NAME" -ForegroundColor Cyan
Write-Host ""
Write-Host "üë• Utilisateurs de test:" -ForegroundColor Cyan
Write-Host "   Admin: testadmin / Admin123!" -ForegroundColor White
Write-Host "   User:  testuser / User123!" -ForegroundColor White
Write-Host ""
Write-Host "üéØ Prochaines √©tapes:" -ForegroundColor Yellow
Write-Host "   1. Acc√©dez √† http://localhost:8180" -ForegroundColor White
Write-Host "   2. V√©rifiez la configuration dans le realm 'ecommerce'" -ForegroundColor White
Write-Host "   3. Configurez le backend avec les variables d'environnement" -ForegroundColor White
Write-Host "   4. Int√©grez le frontend avec Keycloak" -ForegroundColor White
Write-Host ""
